# Item 85 자바 직렬화의 대안을 찾으라.

- 직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화 하지 않는 것이다.
- 여러분이 작성하는 새로운 시스템에서 자바 직렬화를 써야할 이유는 전혀 없다.
- 차선책은 신뢰할 수 없는 데이터는 절대 역직렬화 하지아 않는 것이다.
- 블랙리스트 방식보다는 화이트 리스트 방식을 추천한다. ( 신뢰되는 것만 역직렬화 )

## 직렬화

- 프로그래머가 손쉽게 분산 객체를 만들 수 있다는 점에서 매력적.
- 직렬화의 근본적인 문제는 공격 범위가 너무 넓고 지속적으로 더 넓어저 방어하기 어려움
- objectInputStream , readObject ghcnftl
- 객체 그래프가 역직렬화됨.

```
자바의 역직렬화는 명백하고 현존하는 위험.
신뢰할 수 없느 ㄴ스트림을 역직렬화 하면 원격 코드실행 , 서비스 거부 등의 공격으로 이어질 수 있다.
```

### 직렬화 공격

- 역직렬화에 시간이 오래 걸리는 짧은 스트림을 역직렬화 하는 것만으로 도
  서비스 거부 공격에 쉽게 노출될 수 있음

```java
static byte[] bomb() {
  Set<Object> root = new HashSet<>();
  Set<Object> s1 = root;
  Set<Object> s2 = new HashSet<>();
  for (int i = 0 ; i < 100 ; i++){
    Set<Object> t1 = new HashSet<>();
    Set<Object> t2 = new HashSet<>();
    t1.add("foo");
    s1.add(t1); s1.add(t2);
    s2.add(t1); s2.add(t2);
    s1 = t1;
    s2 = t2;
  }
  return serialize(root); // 이 serialize코드는 생략
}
```

- HashSet 인스턴스를 역직렬화 하려면 그 원소들의 해시코드를 계산해야 한다는데 있다.
- 해쉬코드의 해쉬코드의 해쉬코드 ... 해서 2^100 번 넘게 계산해야함.
- 결국 스택 오버플로우.

### 바이트 방식의 직렬화 말군? JSON,프로토콜 버퍼

- 다른 표현이 좋다.
- 임의 객체 그래프를 자동으로 직렬화/ 역직렬화 하지 않음
- 속성 - 값 쌍의 집합으로 구성된 간단하고 구조화된 데이터 객체를 사용.
- 기본 타입 몇개와 배열 타입만 지원할 뿐!!!

### 객체 역직렬화 필터링

- 피할 수 없다면 이거 써라.
- objectInputFilter
- 자바 9 버전에 추가됨.
- 화이트 리스트로 직렬화할 객체 정의.
